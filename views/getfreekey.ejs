<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= typeof title !== 'undefined' && title ? title : 'ExHub â€” Get Free Key' %></title>
  <link rel="icon" type="image/png" href="/img/ExLogo2.png" />
  <link rel="stylesheet" href="/css/mainv2.css" />
</head>
<body class="page-dark" data-can-renew-global="<%= (typeof canRenew !== 'undefined' && canRenew) ? '1' : '0' %>">

<header class="site-header">
  <div class="container header-inner">
    <a href="/" class="logo">
      <span class="logo-icon">
        <img src="/img/ExLogo2.png" alt="ExHub Logo"
             style="width:100%;height:100%;object-fit:cover;border-radius:12px;" />
      </span>
      <span class="logo-text">ExHub</span>
    </a>

    <nav class="header-nav">
      <% if (typeof user !== 'undefined' && user) { %>
        <div class="header-user">
          <div class="header-user-pill">
            <% if (user.avatar) { %>
              <img
                src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png?size=64"
                alt="Avatar"
                class="header-user-avatar"
              />
            <% } %>
            <span class="user-name"><%= user.global_name || user.username %></span>
          </div>
          <form action="/logout" method="post" style="display:inline;">
            <button type="submit" class="btn btn-ghost">Sign Out</button>
          </form>
        </div>
      <% } else { %>
        <a href="/auth/discord" class="btn btn-primary">Sign in with Discord</a>
      <% } %>
    </nav>
  </div>
</header>

<main class="page-main">
  <div class="container getkey-layout">

    <%
      // =========================
      //  VARIABEL DEFENSIF
      // =========================

      var providerId = (typeof adsProvider !== 'undefined' && adsProvider)
        ? String(adsProvider).toLowerCase()
        : 'workink';
      if (providerId !== 'linkvertise') providerId = 'workink';

      var providerName = (providerId === 'linkvertise') ? 'Linkvertise' : 'Work.ink';
      var providerLogo = (providerId === 'linkvertise')
        ? '/img/linkvertise.png'
        : '/img/workink.jpg';

      var totalSlots = (typeof maxKeys !== 'undefined' && maxKeys != null) ? maxKeys : 5;
      var keysList   = Array.isArray(keys) ? keys : [];
      var usedSlots  = keysList.length;
      var validityHours =
        (typeof defaultKeyHours !== 'undefined' && defaultKeyHours) ? defaultKeyHours : 8;

      // Status checkpoint dari server
      var adsDoneFromServer = (typeof adsProgressDone !== 'undefined') ? !!adsProgressDone : false;
      var adsUsedFromServer = (typeof adsUsedFlag !== 'undefined') ? !!adsUsedFlag : false;

      // Untuk tampilan progress:
      // - 1/1 hanya kalau sudah done dan BELUM digunakan
      // - setelah Generate/Renew berhasil, server set used=true â†’ UI balik 0/1
      var adsProgressUiDone = adsDoneFromServer && !adsUsedFromServer;

      // Batasi tombol berdasarkan server (jangan ada fallback di client)
      var canGenerateBtn = (typeof allowGenerate !== 'undefined') ? !!allowGenerate : false;
      var canRenewGlobal = (typeof canRenew !== 'undefined') ? !!canRenew : false;

      var currentId   = (typeof currentUserId !== 'undefined') ? currentUserId : '';

      // URL ADS â€“ fallback hardcode jika adsUrl tidak dikirim dari server
      var adsDefaultWorkink     = 'https://work.ink/23P2/exhubfreekey';
      var adsDefaultLinkvertise = 'https://linkvertise.com/2995260/uaE3u7P8CG5D?o=sharing';
      var adsUrlFromServer      = (typeof adsUrl !== 'undefined' && adsUrl) ? adsUrl : null;
      var adsUrlSafe = adsUrlFromServer ||
        (providerId === 'linkvertise' ? adsDefaultLinkvertise : adsDefaultWorkink);

      var keyActionUrl   = (typeof keyAction !== 'undefined' && keyAction) ? keyAction : '/getfreekey/generate';
      var renewActionUrl = (typeof renewAction !== 'undefined' && renewAction) ? renewAction : '/getfreekey/extend';

      var errMsg = (typeof errorMessage !== 'undefined' && errorMessage) ? errorMessage : '';
    %>

    <!-- HERO SECTION -->
    <section class="getkey-hero">
      <div class="getkey-hero-left">
        <p class="getkey-eyebrow">Get Free Key</p>
        <h1 class="getkey-title">
          Complete <span>Verification</span>
        </h1>
        <p class="getkey-subtitle">
          Complete a quick verification to get your ExHub key and start using our scripts.
        </p>

        <ul class="getkey-bullets">
          <li>Secure & HWID-aware key system.</li>
          <li>Instant delivery right after verification.</li>
          <li><%= validityHours %>h validity, easy renew when expired.</li>
        </ul>
      </div>

      <div class="getkey-hero-right">
        <div class="getkey-provider-card">
          <div class="getkey-provider-main">
            <div class="getkey-provider-logo-wrap">
              <img
                src="<%= providerLogo %>"
                alt="<%= providerName %>"
                class="getkey-provider-logo"
              />
            </div>
            <div class="getkey-provider-text">
              <p class="provider-name"><%= providerName %></p>
              <p class="provider-caption">
                Complete a short task and get rewarded. Takes less than 2 minutes.
              </p>
            </div>
          </div>

          <div class="getkey-provider-progress">
            <div class="provider-progress-label">
              <span>Progress</span>
              <span><%= adsProgressUiDone ? '1 / 1' : '0 / 1' %></span>
            </div>
            <div class="provider-progress-bar<%= adsProgressUiDone ? ' provider-progress-bar--done' : '' %>">
              <span class="provider-progress-fill"></span>
            </div>
          </div>

          <div class="getkey-provider-actions">
            <a
              href="<%= adsUrlSafe %>"
              class="btn-getkey-main"
            >
              START
            </a>

            <% if (!adsDoneFromServer) { %>
              <p class="getkey-helper-text">
                Complete the verification first to unlock <strong>Generate</strong> or <strong>Renew</strong>.
              </p>
            <% } else if (adsUsedFromServer) { %>
              <p class="getkey-helper-text">
                This verification has been used. Run <strong>START</strong> again for a new action.
              </p>
            <% } else { %>
              <p class="getkey-helper-text">
                Checkpoint unlocked â€” you can <strong>Generate</strong> or <strong>Renew</strong> one key.
              </p>
            <% } %>
          </div>
        </div>
      </div>
    </section>

    <!-- KEYS LIST / TABLE -->
    <section class="getkey-keys-section">
      <header class="getkey-keys-header">
        <div>
          <h2>Your Keys</h2>
          <p class="getkey-keys-caption">
            Your keys (<%= usedSlots %> / <%= totalSlots %>)
          </p>
        </div>
      </header>

      <% if (errMsg) { %>
        <div class="auth-error getkey-error"><%= errMsg %></div>
      <% } %>

      <div class="getkey-keys-table">
        <div class="getkey-row getkey-row--head">
          <div>Key</div>
          <div>Time Left</div>
          <div>Status</div>
          <div>Actions</div>
        </div>

        <% if (keysList.length > 0) { %>
          <% keysList.forEach(function(k) { 
               var isActive  = (k.status === 'Active');
               var isExpired = (k.status === 'Expired');
               // Renew hanya relevan kalau Expired
               var showRenewInitially = isExpired;
               // Renew enable hanya kalau server bilang boleh (ads done & belum used)
               var renewDisabledAtRender = !canRenewGlobal || !showRenewInitially;

               // Ambil timestamp expiry (ms) untuk countdown realtime
               var expMsStr = '';
               if (typeof k.expiresAfter !== 'undefined' && k.expiresAfter != null) {
                 expMsStr = String(k.expiresAfter);
               } else if (typeof k.expiresAtMs !== 'undefined' && k.expiresAtMs != null) {
                 expMsStr = String(k.expiresAtMs);
               } else if (typeof k.expiresAt !== 'undefined' && k.expiresAt != null) {
                 expMsStr = String(k.expiresAt);
               }
          %>
            <div
              class="getkey-row"
              data-token="<%= k.token %>"
              data-status="<%= k.status || 'Active' %>"
              data-expires-ms="<%= expMsStr %>"
            >
              <div class="getkey-key">
                <code><%= k.token %></code>
              </div>
              <div class="getkey-time">
                <%= k.timeLeftLabel || '-' %>
              </div>
              <div class="getkey-status">
                <span class="badge <%= isActive ? 'badge-active' : 'badge-inactive' %>">
                  <span class="badge-dot"></span>
                  <%= k.status || 'Active' %>
                </span>
              </div>
              <div class="getkey-actions">
                <!-- Copy selalu tersedia -->
                <button
                  type="button"
                  class="btn-icon-mini"
                  onclick="navigator.clipboard.writeText('<%= k.token %>')">
                  ðŸ“‹
                </button>

                <!-- Renew selalu ada di DOM, tapi:
                     - disembunyikan kalau belum Expired
                     - di-enable realtime lewat JS saat Time Left jadi 0 -->
                <form method="post"
                      action="<%= renewActionUrl %>?ads=<%= providerId %>"
                      class="inline-form renew-form"
                      style="<%= showRenewInitially ? '' : 'display:none;' %>">
                  <% if (currentId) { %>
                    <input type="hidden" name="userId" value="<%= currentId %>" />
                  <% } %>
                  <input type="hidden" name="token" value="<%= k.token %>" />
                  <button
                    type="submit"
                    class="btn-renew"
                    <% if (renewDisabledAtRender) { %>disabled<% } %>>
                    Renew
                  </button>
                </form>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="getkey-keys-empty">
            No keys yet. Finish the verification above and use
            <strong>Generate Free Key</strong> below to receive your first key.
          </div>
        <% } %>
      </div>
    </section>

    <!-- CTA BAWAH â€“ GENERATE FREE KEY DI TENGAH -->
    <section class="getkey-cta-main" style="margin-top:24px;">
      <div style="text-align:center;">
        <form method="post" action="<%= keyActionUrl %>?ads=<%= providerId %>">
          <% if (currentId) { %>
            <input type="hidden" name="userId" value="<%= currentId %>" />
          <% } %>
          <button
            type="submit"
            class="btn btn-primary btn-cta-main"
            style="min-width:220px;padding:10px 22px;font-size:0.95rem;"
            <% if (!canGenerateBtn) { %>disabled<% } %>>
            Generate Free Key
          </button>
        </form>
        <p class="getkey-cta-caption" style="margin-top:8px;font-size:0.8rem;color:#9ca3c0;">
          One action per verification â€” choose <strong>Generate</strong> or <strong>Renew</strong> after completing ads.
        </p>
      </div>
    </section>

  </div>
</main>

<script>
(function() {
  try {
    // Sembunyikan ?done=1 di URL, tetap pertahankan ?ads=workink / ?ads=linkvertise
    var params = new URLSearchParams(window.location.search);
    var done = params.get('done');
    if (done === '1') {
      params.delete('done');
      if (!params.get('ads')) {
        params.set('ads', '<%= providerId %>');
      }
      var newUrl = window.location.pathname + '?' + params.toString();
      window.history.replaceState({}, '', newUrl);
    }
  } catch (e) {
    // ignore
  }
})();

(function() {
  // Countdown realtime + auto switch ke Expired + show/enable Renew
  function pad(n) {
    return n < 10 ? '0' + n : '' + n;
  }

  function formatMs(ms) {
    if (ms <= 0) return 'Expired';
    var sec = Math.floor(ms / 1000);
    var h = Math.floor(sec / 3600);
    var m = Math.floor((sec % 3600) / 60);
    var s = sec % 60;
    return pad(h) + ':' + pad(m) + ':' + pad(s);
  }

  var canRenewGlobal = document.body.getAttribute('data-can-renew-global') === '1';

  function tick() {
    var now = Date.now();
    var rows = document.querySelectorAll('.getkey-row[data-expires-ms]');
    rows.forEach(function(row) {
      var expStr = row.getAttribute('data-expires-ms');
      if (!expStr) return;
      var expMs = parseInt(expStr, 10);
      if (!expMs || isNaN(expMs)) return;

      var msLeft = expMs - now;
      var timeCell   = row.querySelector('.getkey-time');
      var badge      = row.querySelector('.getkey-status .badge');
      var renewForm  = row.querySelector('.renew-form');
      var renewBtn   = row.querySelector('.btn-renew');

      if (!timeCell) return;

      if (msLeft > 0) {
        timeCell.textContent = formatMs(msLeft);
      } else {
        // Sudah expired
        timeCell.textContent = 'Expired';

        // Update badge ke Expired (warna inactive)
        if (badge) {
          badge.classList.remove('badge-active');
          badge.classList.add('badge-inactive');
          badge.innerHTML = '<span class="badge-dot"></span>Expired';
        }

        // Tampilkan form Renew jika ada
        if (renewForm) {
          renewForm.style.display = '';
        }

        // Enable tombol Renew hanya jika server mengizinkan (checkpoint ads)
        if (renewBtn && canRenewGlobal) {
          renewBtn.disabled = false;
        }
      }
    });
  }

  tick();
  setInterval(tick, 1000);
})();
</script>

<!-- Proteksi dasar: blokir klik kanan + beberapa shortcut DevTools -->
<script src="/js/protect-devtools.js"></script>
</body>
</html>
